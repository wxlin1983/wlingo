<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI Quiz</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <div class="progress-bar-container">
        <div class="progress-bar" style="width: {{ ((current_index + 1) / total_questions) * 100 }}%;"></div>
    </div>

    <div class="main-content">
        <h1>Which one of these is "{{ word }}"?</h1>
        <p class="question-info">Question {{ current_index + 1 }} of {{ total_questions }}</p>

        <form id="quiz-form" method="POST" action="/submit_answer">
            <input type="hidden" name="current_index" value="{{ current_index }}">

            <div class="options-container" id="options-container">
                {% for option in options %}
                    {% set is_checked = answer_record and answer_record.user_answer == option %}
                    <div class="option-item 
                        {% if answer_record %}
                            {% if option == answer_record.correct_answer %}
                                correct
                            {% elif option == answer_record.user_answer and not answer_record.is_correct %}
                                incorrect
                            {% endif %}
                        {% endif %}
                        ">
                        <input 
                            type="radio" 
                            id="option-{{ loop.index }}" 
                            name="answer" 
                            value="{{ option }}"
                            class="option-input"
                            data-translation="{{ option }}"
                            {% if is_checked %} checked {% endif %}
                            {% if answer_record %} disabled {% endif %}
                            >
                        <label for="option-{{ loop.index }}">{{ option }}</label>
                    </div>
                {% endfor %}
            </div>
            
            <div class="footer-action-buttons">
                <button type="submit" id="submit-btn" class="btn btn-primary"
                    {% if answer_record %} disabled {% endif %}
                >
                    Submit Answer
                </button>
            </div>
        </form>
    </div>

    <div id="feedback-panel" class="feedback-panel" 
        {% if not answer_record %} style="display: none;" {% endif %}
        >
        {% if answer_record %}
            {% if answer_record.is_correct %}
                <h3 class="correct-text">âœ… Correct!</h3>
            {% else %}
                <h3 class="incorrect-text">âŒ Incorrect.</h3>
                <p>The correct answer is: **{{ answer_record.correct_answer }}**</p>
            {% endif %}

            <div class="navigation-controls">
                {% if not is_first_question %}
                    <a href="/quiz/{{ current_index - 1 }}" class="btn btn-secondary">Previous â¬…ï¸</a>
                {% endif %}

                {% if not is_last_question %}
                    <a href="/quiz/{{ current_index + 1 }}" id="next-btn" class="btn btn-primary">Next â¡ï¸</a>
                {% else %}
                    <a href="/result" id="finish-btn" class="btn btn-success">Finish Quiz ğŸ‰</a>
                {% endif %}
            </div>

        {% endif %}
    </div>

    <script>
        const form = document.getElementById('quiz-form');
        const submitButton = document.getElementById('submit-btn');
        const optionsContainer = document.getElementById('options-container');
        const feedbackPanel = document.getElementById('feedback-panel');

        form.addEventListener('submit', async function(e) {
            e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­çš„è¡¨å–®æäº¤
            
            // æª¢æŸ¥æ˜¯å¦æœ‰é¸ä¸­é¸é …
            const selectedInput = form.querySelector('input[name="answer"]:checked');
            if (!selectedInput) {
                alert("Please select an answer.");
                return;
            }

            // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
            submitButton.disabled = true;

            const formData = new FormData(form);
            
            try {
                const response = await fetch('/submit_answer', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    // 1. ç¦ç”¨æ‰€æœ‰é¸é … (é˜²æ­¢æ›´æ”¹ç­”æ¡ˆ)
                    const radioInputs = optionsContainer.querySelectorAll('input[type="radio"]');
                    radioInputs.forEach(input => input.disabled = true);
                    
                    // 2. æ‡‰ç”¨ CSS æ¨£å¼å’Œè¦–è¦ºå›é¥‹
                    applyFeedbackStyles(data, selectedInput.value);

                    // 3. é¡¯ç¤ºå›é¥‹é¢æ¿å’Œå°èˆªæŒ‰éˆ•
                    renderFeedbackPanel(data);

                } else {
                    // å¦‚æœä¼ºæœå™¨è¿”å›éŒ¯èª¤ (ä¾‹å¦‚: å·²æäº¤éç­”æ¡ˆ), é‡æ–°å•Ÿç”¨æäº¤æŒ‰éˆ•
                    alert(data.error || "Submission failed.");
                    submitButton.disabled = false;
                }

            } catch (error) {
                console.error('Error submitting answer:', error);
                alert('An unexpected error occurred.');
                submitButton.disabled = false; // å‡ºéŒ¯æ™‚é‡æ–°å•Ÿç”¨æŒ‰éˆ•
            }
        });

        // å‡½å¼: æ ¹æ“šæäº¤çµæœæ›´æ–°æ¨£å¼
        function applyFeedbackStyles(record, userAnswer) {
            const items = optionsContainer.querySelectorAll('.option-item');
            
            items.forEach(item => {
                const input = item.querySelector('input');
                const optionValue = input.value;

                item.classList.remove('selected');

                if (optionValue === record.correct_answer) {
                    // æ­£ç¢ºç­”æ¡ˆæ¨™è¨˜ç‚ºç¶ è‰²
                    item.classList.add('correct');
                } else if (optionValue === userAnswer && !record.is_correct) {
                    // éŒ¯èª¤ç­”æ¡ˆæ¨™è¨˜ç‚ºç´…è‰²
                    item.classList.add('incorrect');
                }
            });
        }

        // å‡½å¼: æ¸²æŸ“å›é¥‹é¢æ¿
        function renderFeedbackPanel(record) {
            let panelContent = '';
            
            if (record.is_correct) {
                panelContent += '<h3 class="correct-text">âœ… Correct!</h3>';
            } else {
                panelContent += '<h3 class="incorrect-text">âŒ Incorrect.</h3>';
                panelContent += `<p>The correct answer is: <strong>${record.correct_answer}</strong></p>`;
            }

            // å°èˆªæ§åˆ¶é …
            const currentIndex = parseInt(document.querySelector('input[name="current_index"]').value);
            const totalQuestions = parseInt('{{ total_questions }}');

            panelContent += '<div class="navigation-controls">';

            // Previous Button
            if (currentIndex > 0) {
                panelContent += `<a href="/quiz/${currentIndex - 1}" class="btn btn-secondary">Previous â¬…ï¸</a>`;
            }

            // Next/Finish Button
            if (currentIndex < totalQuestions - 1) {
                panelContent += `<a href="/quiz/${currentIndex + 1}" id="next-btn" class="btn btn-primary">Next â¡ï¸</a>`;
            } else {
                panelContent += `<a href="/result" id="finish-btn" class="btn btn-success">Finish Quiz ğŸ‰</a>`;
            }

            panelContent += '</div>';

            feedbackPanel.innerHTML = panelContent;
            feedbackPanel.style.display = 'block'; // é¡¯ç¤ºå›é¥‹é¢æ¿
        }

        // é é¢è¼‰å…¥æ™‚ï¼Œå¦‚æœå·²æœ‰ç­”æ¡ˆï¼Œç¢ºä¿å•Ÿç”¨é¢æ¿ä¸¦ç¦ç”¨æŒ‰éˆ•
        window.onload = () => {
             if ({{ 'true' if answer_record else 'false' }}) {
                submitButton.disabled = true;
                feedbackPanel.style.display = 'block';
            }
        };

    </script>
</body>
</html>