<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Quiz</title>
    <link href="/static/style.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Basic styling for dynamic elements */
        .option-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            cursor: pointer;
            font-size: 1.1em;
        }

        .option-btn:hover {
            background-color: #e0e0e0;
        }

        .correct {
            background-color: #d4edda !important;
            border-color: #c3e6cb;
        }

        .incorrect {
            background-color: #f8d7da !important;
            border-color: #f5c6cb;
        }

        .disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        #loading {
            font-style: italic;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Vocabulary Quiz</h1>

        <div id="progress-container">
            Question <span id="current-q"></span> of <span id="total-q"></span>
        </div>

        <hr>

        <div id="quiz-content">
            <h2 id="word-display">Loading...</h2>

            <div id="options-container">
            </div>

            <div id="feedback-message" style="margin-top: 15px; font-weight: bold;"></div>
        </div>

        <div style="margin-top: 20px;">
            <button id="next-btn" style="display:none;">Next Question >></button>
            <a href="/result" id="finish-btn" style="display:none;">See Results</a>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Get the index passed from FastAPI
            const currentIndex = {{ current_index }};

            // --- 1. Load Question Data ---
            function loadQuestion() {
                $.get(`/api/quiz/${currentIndex}`)
                    .done(function(data) {
                        // Update Text Elements
                        $('#word-display').text(data.word);
                        $('#current-q').text(data.current_index + 1);
                        $('#total-q').text(data.total_questions);

                        const $container = $('#options-container').empty();

                        // Generate Buttons
                        $.each(data.options, function(index, option) {
                            const $btn = $('<button>')
                                .addClass('option-btn')
                                .text(option)
                                .on('click', function() {
                                    submitAnswer(index, $(this));
                                });

                            // Apply styles if already answered
                            if (data.answer_record) {
                                $btn.addClass('disabled');
                                if (option === data.answer_record.correct_answer) $btn.addClass('correct');
                                if (option === data.answer_record.user_answer && !data.answer_record.is_correct) $btn.addClass('incorrect');
                            }

                            $container.append($btn);
                        });

                        // Show navigation if answered
                        if (data.answer_record) {
                            showNextButton(data.total_questions);
                        }
                    })
                    .fail(function() {
                        $('#word-display').text("Error loading question.");
                        console.error("Load failed");
                    });
            }

            // --- 2. Submit Answer ---
            function submitAnswer(selectedIndex, $clickedBtn) {
                // Disable all buttons immediately
                $('.option-btn').addClass('disabled');

                // Send data using jQuery POST
                // jQuery automatically formats this object for Form(...) in FastAPI
                $.post('/submit_answer', {
                    selected_option_index: selectedIndex,
                    current_index: currentIndex
                })
                .done(function(result) {
                    // Update Button Colors
                    $('.option-btn').each(function() {
                        const $btn = $(this);
                        if ($btn.text() === result.correct_answer) {
                            $btn.addClass('correct');
                        }
                        // Highlight clicked button if wrong
                        if ($btn.is($clickedBtn) && !result.is_correct) {
                            $btn.addClass('incorrect');
                        }
                    });

                    // Update Feedback Text
                    const $feedback = $('#feedback-message');
                    if (result.is_correct) {
                        $feedback.text("Correct!").css('color', '#155724');
                    } else {
                        $feedback.text(`Wrong! The answer is ${result.correct_answer}`).css('color', '#721c24');
                    }

                    // Show Navigation
                    const totalQ = parseInt($('#total-q').text());
                    showNextButton(totalQ);
                })
                .fail(function(xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : "Submission failed";
                    alert("Error: " + errorMsg);
                });
            }

            // --- 3. Helpers ---
            function showNextButton(totalQuestions) {
                const nextIndex = currentIndex + 1;
                if (nextIndex < totalQuestions) {
                    $('#next-btn').css('display', 'inline-block');
                } else {
                    $('#finish-btn').css('display', 'inline-block');
                }
            }

            // Bind Next Button Click
            $('#next-btn').on('click', function() {
                window.location.href = `/quiz/${currentIndex + 1}`;
            });

            // Initialize Page
            loadQuestion();
        });
    </script>
</body>

</html>